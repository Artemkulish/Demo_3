variables:
    PATH_TO_JAR:    /target/*.jar
    #IP:             10.128.0.13
    #IP: $ENV-VARIEBLE
    
stages:
    - build
    - deploy    
    - update
    

.build_template: &build_template
    stage: build
    script:
        - cd $PATH_TO_APP
        - mvn clean package
        - sudo docker build -t gitlab.svagworks.me:5050/root/demo_3:$PATH_TO_APP .
        - sudo docker push gitlab.svagworks.me:5050/root/demo_3:$PATH_TO_APP
    artifacts:
        paths:
        - $PATH_TO_APP$PATH_TO_JAR
        expire_in: 1 day
   

build_identity:
    <<: *build_template
    variables:
        PATH_TO_APP: identity/identity-service
    only:
        changes:
            - identity/**/*

build_messaging:
    <<: *build_template
    variables:
        PATH_TO_APP: messaging
    only:
        changes:
            - messaging/**/*
        
build_payment:
    <<: *build_template
    variables:
       PATH_TO_APP: payment
    only:
        changes:
           - payment/**/*

build_simulation:
    <<: *build_template
    variables:
        PATH_TO_APP: simulation     
    only:
        changes:
            - simulation/**/*

build_trip:
    <<: *build_template
    variables:
        PATH_TO_APP: trip     
    only:
        changes:
            - trip/**/*

build_vehicle:
    <<: *build_template
    variables:
        PATH_TO_APP: vehicle     
    only:
        changes:
            - vehicle/**/*


.deploy_template: &deploy_template
    stage: deploy
    script:
      - scp -r /home/env docker-compose.yml deploy.sh $USERNAME@$IP:/tmp
      - ssh $USERNAME@$IP "sudo mv /tmp/*.jar /var/ && sudo mv /tmp/docker-compose.yml /var/ && sudo mv /tmp/deploy.sh /var/"
      - ssh $USERNAME@$IP "sudo bash /var/deploy.sh"
      #- ssh $USERNAME@$IP "sudo docker pull gitlab.svagworks.me:5050/root/demo_3:$PATH_TO_APP"

deploy_identity:
    <<: *deploy_template
    variables:
        PATH_TO_APP: identity/identity-service
    only:
        changes:
            - identity/**/*
    #dependencies:
    #    - build_identity

deploy_messaging:
    <<: *deploy_template
    variables:
        PATH_TO_APP: messaging
    only:
        changes:
            - messaging/**/*
        
deploy_payment:
    <<: *deploy_template
    variables:
        PATH_TO_APP: payment
    only:
        changes:
            - payment/**/*
        
deploy_simulation:
    <<: *deploy_template
    variables:
        PATH_TO_APP: simulation
    only:
        changes:
            - simulation/**/*
        
deploy_trip:
    <<: *deploy_template
    variables:
        PATH_TO_APP: trip
    only:
        changes:
            - trip/**/*
        
deploy_vehicle:
    <<: *deploy_template
    variables:
        PATH_TO_APP: vehicle
    only:
        changes:
            - vehicle/**/*
                
                
