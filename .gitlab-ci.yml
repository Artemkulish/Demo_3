stages:
    - build
    - deploy    
    - update
    
variables:
    PATH_TO_JAR:    /target/*.jar    

.build_template: &build_template
    stage: build
    script:
        - cd $PATH_TO_APP
        - mvn clean package
        - sudo docker build -t gitlab.svagworks.me:5050/root/demo_3:$PATH_TO_APP .
        - sudo docker push gitlab.svagworks.me:5050/root/demo_3:$PATH_TO_APP

build_messaging:
    <<: *build_template
    variables:
        PATH_TO_APP: messaging
    only:
        changes:
            - messaging/**/*
        
build_payment:
    <<: *build_template
    variables:
       PATH_TO_APP: payment
    only:
        changes:
           - payment/**/*

build_simulation:
    <<: *build_template
    variables:
        PATH_TO_APP: simulation     
    only:
        changes:
            - simulation/**/*

build_trip:
    <<: *build_template
    variables:
        PATH_TO_APP: trip     
    only:
        changes:
            - trip/**/*

build_vehicle:
    <<: *build_template
    variables:
        PATH_TO_APP: vehicle     
    only:
        changes:
            - vehicle/**/*

build_identity:
    stage: build
    script:
        - cd identity/identity-starter && mvn clean install
        - cd ../identity-service && mvn clean package
        - sudo docker build -t gitlab.svagworks.me:5050/root/demo_3:identity .
        - sudo docker push gitlab.svagworks.me:5050/root/demo_3:identity
    only:
        changes:
            - identity/**/*

.deploy_template: &deploy_template
    stage: deploy
    script:
      - INSTANCE_IP=$(cat ~/instance_ip)
      - scp -r /home/env docker-compose.yml deploy.sh $USERNAME@$INSTANCE_IP:/tmp
      - ssh $USERNAME@$INSTANCE_IP "sudo cp -r /tmp/env /var/ && sudo mv /tmp/docker-compose.yml /var/ && sudo mv /tmp/deploy.sh /var/"
      - ssh $USERNAME@$INSTANCE_IP "cd /var/ && sudo bash /var/deploy.sh"
      
deploy_identity:
    <<: *deploy_template
    only:
        changes:
            - identity/**/*

deploy_messaging:
    <<: *deploy_template
    only:
        changes:
            - messaging/**/*
        
deploy_payment:
    <<: *deploy_template
    only:
        changes:
            - payment/**/*
        
deploy_simulation:
    <<: *deploy_template
    only:
        changes:
            - simulation/**/*
        
deploy_trip:
    <<: *deploy_template
    only:
        changes:
            - trip/**/*
        
deploy_vehicle:
    <<: *deploy_template
    only:
        changes:
            - vehicle/**/*


.database_template: &database_template
    stage: update
    script:
        - cd trip
        - mvn liquibase:$FUNCTION
    when: manual
    
database_update:
    <<: *database_template
    variables:
        FUNCTION: update
    only:
        changes:
            - dbchangelog.xml  
    
database_rollback:
    <<: *database_template
    variables:
        FUNCTION: rollback -Dliquibase.rollbackCount=1
    only:
        changes:
            - dbchangelog.xml  
